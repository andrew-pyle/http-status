<script lang="ts">
  import { onMount } from "svelte";

  import StatusCode from "./StatusCode.svelte";
  import type {
    StatusCodeApiResponse,
    StatusCode as StatusCodeType,
  } from "./types";

  export let searchText: string;
  let codesList: StatusCodeType[] = [];
  let matchingCodes: StatusCodeType[] = [];
  let componentStatus: "loading" | "failed" | "success" = "loading";
  $: {
    matchingCodes = searchForCode(searchText, codesList);
  }

  onMount(async () => {
    const res = await fetch(
      "https://raw.githubusercontent.com/for-GET/know-your-http-well/master/json/status-codes.json"
    );
    if (!res.ok) {
      componentStatus = "failed";
    }
    const data = (await res.json()) as StatusCodeApiResponse;

    codesList = data.map((element) => ({
      code: element.code,
      text: element.phrase,
      description: element.description,
      link: new URL(element.spec_href),
    }));
    console.log({ codesList });
    componentStatus = "success";
  });

  function searchForCode(
    searchText: string,
    codesList: StatusCodeType[]
  ): StatusCodeType[] {
    // Short circuit if no input
    if (searchText.length === 0) {
      return [];
    }
    // Return only one result if the input is an exact code
    const directHit = codesList.find(
      (statusCode) => statusCode.code === searchText
    );
    if (directHit) {
      return [directHit];
    }
    // Return input matches in code, text, or description
    return codesList.filter(
      (statusCode) =>
        statusCode.code.toString().includes(searchText) ||
        statusCode.text.includes(searchText) ||
        statusCode.description.includes(searchText)
    );
  }
</script>

{#if componentStatus === "success"}
  <ul class="status-code-list">
    {#each matchingCodes as { code, text, description, link }}
      <li><StatusCode {code} {text} {description} {link} /></li>
    {/each}
  </ul>
{:else if componentStatus === "loading"}
  <p>ðŸ™ƒ Loading...</p>
{:else}
  <p>ðŸ˜µ Error.</p>
{/if}

<style>
  .status-code-list {
    list-style-type: none;
  }
</style>
